---
# yaml-language-server: $schema=https://kubernetes-schemas.pages.dev/source.toolkit.fluxcd.io/ocirepository_v1.json
apiVersion: source.toolkit.fluxcd.io/v1
kind: OCIRepository
metadata:
  name: mimir
spec:
  interval: 30m
  layerSelector:
    mediaType: application/vnd.cncf.helm.chart.content.v1.tar+gzip
    operation: copy
  ref:
    tag: 5.6.0
  url: oci://ghcr.io/grafana/helm-charts/mimir-distributed
---
# yaml-language-server: $schema=https://kubernetes-schemas.pages.dev/helm.toolkit.fluxcd.io/helmrelease_v2.json
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: mimir
spec:
  interval: 1h
  chartRef:
    kind: OCIRepository
    name: mimir
  install:
    remediation:
      retries: 3
  upgrade:
    cleanupOnFail: true
    remediation:
      retries: 3
  dependsOn:
    - name: openebs
      namespace: openebs-system
  values:
    # Monolithic mode for home lab - simpler deployment
    deploymentMode: SingleBinary

    # Disable built-in MinIO - we use our own
    minio:
      enabled: false

    # Single binary configuration
    mimir:
      # Disable multi-tenancy for home lab
      structuredConfig:
        multitenancy_enabled: false

        # Server configuration
        server:
          http_listen_port: 8080
          grpc_listen_port: 9095
          log_level: warn

        # Common storage configuration
        common:
          storage:
            backend: s3
            s3:
              endpoint: minio.storage.svc.cluster.local:9000
              region: us-east-1
              insecure: true
              access_key_id: ${AWS_ACCESS_KEY_ID}
              secret_access_key: ${AWS_SECRET_ACCESS_KEY}

        # Blocks storage (metrics data)
        blocks_storage:
          backend: s3
          s3:
            bucket_name: mimir-blocks
          tsdb:
            dir: /data/tsdb
          bucket_store:
            sync_dir: /data/tsdb-sync

        # Alertmanager storage
        alertmanager_storage:
          backend: s3
          s3:
            bucket_name: mimir-alertmanager

        # Ruler storage
        ruler_storage:
          backend: s3
          s3:
            bucket_name: mimir-ruler

        # Compactor configuration
        compactor:
          data_dir: /data/compactor
          sharding_ring:
            kvstore:
              store: memberlist

        # Distributor configuration
        distributor:
          ring:
            instance_addr: 127.0.0.1
            kvstore:
              store: memberlist

        # Ingester configuration
        ingester:
          ring:
            instance_addr: 127.0.0.1
            kvstore:
              store: memberlist
            replication_factor: 1

        # Store gateway configuration
        store_gateway:
          sharding_ring:
            replication_factor: 1

        # Limits configuration
        limits:
          # Ingestion limits
          ingestion_rate: 10000
          ingestion_burst_size: 200000
          # Query limits
          max_query_parallelism: 32
          max_global_series_per_user: 0
          max_global_series_per_metric: 0
          # Retention
          compactor_blocks_retention_period: 30d

    # Single binary deployment
    single_binary:
      replicas: 1
      resources:
        requests:
          cpu: 200m
          memory: 512Mi
        limits:
          cpu: 1000m
          memory: 2Gi
      persistence:
        enabled: true
        storageClass: openebs-hostpath
        size: 50Gi
      extraEnv:
        - name: TZ
          value: "Europe/London"

    # Disable distributed components (using single binary)
    alertmanager:
      enabled: false
    compactor:
      enabled: false
    distributor:
      enabled: false
    ingester:
      enabled: false
    overrides_exporter:
      enabled: false
    querier:
      enabled: false
    query_frontend:
      enabled: false
    query_scheduler:
      enabled: false
    ruler:
      enabled: false
    store_gateway:
      enabled: false

    # Disable caches for single binary mode
    chunks-cache:
      enabled: false
    index-cache:
      enabled: false
    metadata-cache:
      enabled: false
    results-cache:
      enabled: false

    # Disable nginx gateway - access directly
    nginx:
      enabled: false

    # Monitoring
    metaMonitoring:
      serviceMonitor:
        enabled: true
        interval: 1m

    # Global settings for S3 credentials
    global:
      extraEnvFrom:
        - secretRef:
            name: mimir-s3

  valuesFrom:
    - kind: Secret
      name: mimir-s3
      valuesKey: values.yaml
      optional: true

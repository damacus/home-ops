---
# yaml-language-server: $schema=https://taskfile.dev/schema.json
version: "3"

vars:
  CERTS_DIR: "certificates"

tasks:
  download-certificates:
    desc: Download the certificates from the cluster
    dir: "{{.CERTS_DIR}}"
    cmd: |
      kubectl get secrets -n network ironstone-casa-production-tls -o yaml | yq e '.data."tls.crt"' | base64 -d > ironstone-casa-tls.crt
      kubectl get secrets -n network ironstone-casa-production-tls -o yaml | yq e '.data."tls.key"' | base64 -d > ironstone-casa-tls.key
  check-certificates:
    desc: Check the certificates
    dir: "{{.CERTS_DIR}}"
    cmd: |
      openssl x509 -in ironstone-casa-tls.crt -text -noout | grep -A 2 Validity
      openssl rsa -in ironstone-casa-tls.key -check
  generate-unifi-keystore:
    desc: Generate the Unifi keystore
    dir: "{{.CERTS_DIR}}"
    cmd: |
      openssl pkcs12 -export -in ironstone-casa-tls.crt -inkey ironstone-casa-tls.key -out ironstone-keystore.p12 -name "unifi"
  upload-certificates:
    desc: Upload the certificates to Synology
    dir: "{{.CERTS_DIR}}"
    cmd: |
      scp ironstone-casa-tls.crt synology:/usr/syno/etc/certificate/system/default/cert.pem
      scp ironstone-casa-tls.crt synology:/usr/syno/etc/certificate/system/default/fullchain.pem
      scp ironstone-casa-tls.key synology:/usr/syno/etc/certificate/system/default/privkey.pem

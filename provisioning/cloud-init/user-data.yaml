#cloud-config
# =============================================================================
# Ironstone K3s Node - Cloud-Init Configuration
# =============================================================================
# This cloud-init config provisions a k3s worker node.
# No Ansible required - everything is done via cloud-init.
# =============================================================================

# Debug output
output:
  all: "| tee -a /var/log/cloud-init-output.log"
final_message: "cloud-init finished"

preserve_hostname: false
manage_etc_hosts: true
timezone: Europe/London
locale: en_GB.UTF-8

ssh_pwauth: false
disable_root: true

users:
  - name: pi
    gecos: Ironstone Admin
    groups: [adm, sudo]
    shell: /bin/bash
    sudo: ALL=(ALL) NOPASSWD:ALL
    lock_passwd: true
    ssh_import_id:
      - gh:damacus

write_files:
  - path: /etc/ssh/sshd_config.d/99-harden.conf
    owner: root:root
    permissions: "0644"
    content: |
      PasswordAuthentication no
      PermitRootLogin no
      AuthenticationMethods publickey
      KbdInteractiveAuthentication no
      MaxAuthTries 3
      LoginGraceTime 30s

  - path: /etc/sysctl.d/99-k8s.conf
    owner: root:root
    permissions: "0644"
    content: |
      net.ipv4.ip_forward = 1
      net.ipv6.conf.all.forwarding = 1
      fs.inotify.max_queued_events = 65536
      fs.inotify.max_user_watches = 524288
      fs.inotify.max_user_instances = 8192
      fs.file-max = 2097152
      net.ipv4.neigh.default.gc_thresh1 = 4096
      net.ipv4.neigh.default.gc_thresh2 = 8192
      net.ipv4.neigh.default.gc_thresh3 = 16384
      vm.swappiness = 0

  - path: /etc/modules-load.d/k8s-modules.conf
    owner: root:root
    permissions: "0644"
    content: |
      overlay
      br_netfilter
      ip_tables
      ip6_tables
      nf_nat
      xt_conntrack

  - path: /etc/rancher/k3s/config.yaml
    owner: root:root
    permissions: "0600"
    content: |
      server: https://__K3S_VIP__:6443
      token-file: /etc/rancher/k3s/cluster-token
      node-label:
        - "ironstone.casa/managed=true"
      kubelet-arg:
        - "register-with-taints=node.kubernetes.io/unschedulable:NoSchedule"

  - path: /usr/local/bin/k3s-init.sh
    owner: root:root
    permissions: "0755"
    content: |
      #!/bin/bash
      set -euo pipefail
      LOG_TAG="k3s-init"
      log() { logger -t "$LOG_TAG" "$*"; echo "[$(date '+%Y-%m-%d %H:%M:%S')] $*"; }

      # NFS settings
      NFS_SERVER="__NFS_SERVER__"
      NFS_SHARE="__NFS_SHARE__"
      TOKEN_PATH="provisioning/token"

      # Check if already initialized
      if [ -f /etc/rancher/k3s/cluster-token ] && [ -s /etc/rancher/k3s/cluster-token ]; then
          log "K3s token already exists, skipping NFS fetch"
      else
          log "Fetching k3s token from NFS..."
          mkdir -p /mnt/nfs /etc/rancher/k3s

          if timeout 10s mount -t nfs "${NFS_SERVER}:${NFS_SHARE}" /mnt/nfs -o ro,nolock,nfsvers=3,soft,timeo=10,retrans=1 2>/dev/null; then
              if [ -f "/mnt/nfs/$TOKEN_PATH" ]; then
                  cp "/mnt/nfs/$TOKEN_PATH" /etc/rancher/k3s/cluster-token
                  chmod 600 /etc/rancher/k3s/cluster-token
                  log "K3s token copied successfully"
              else
                  log "ERROR: Token not found at /mnt/nfs/$TOKEN_PATH"
                  umount /mnt/nfs 2>/dev/null || true
                  exit 1
              fi
              umount /mnt/nfs 2>/dev/null || true
          else
              log "ERROR: Failed to mount NFS"
              exit 1
          fi
      fi

      # Start k3s agent
      log "Starting k3s agent (node will be cordoned)..."
      exec /usr/local/bin/k3s agent

  - path: /etc/systemd/system/k3s.service
    owner: root:root
    permissions: "0644"
    content: |
      [Unit]
      Description=K3s Agent
      Documentation=https://k3s.io
      Wants=network-online.target
      After=network-online.target

      [Service]
      Type=exec
      EnvironmentFile=-/etc/default/k3s
      ExecStart=/usr/local/bin/k3s-init.sh
      KillMode=process
      Delegate=yes
      LimitNOFILE=1048576
      LimitNPROC=infinity
      LimitCORE=infinity
      TasksMax=infinity
      TimeoutStartSec=0
      Restart=always
      RestartSec=5s

      [Install]
      WantedBy=multi-user.target

  - path: /var/lib/cloud/scripts/per-instance/99-dump-logs.sh
    owner: root:root
    permissions: "0755"
    content: |
      #!/bin/bash
      set -euo pipefail
      install -d -o pi -g pi /home/pi/logs
      {
        journalctl -b -o short-iso --no-pager \
          -u cloud-init-local -u cloud-init -u cloud-config -u cloud-final || true
        echo "### /var/log/cloud-init.log"
        [ -s /var/log/cloud-init.log ] && cat /var/log/cloud-init.log || echo "(missing)"
      } > /home/pi/logs/cloud-init-full.log
      chown -R pi:pi /home/pi/logs

package_update: true
package_upgrade: false

packages:
  - apt-transport-https
  - ca-certificates
  - conntrack
  - curl
  - dirmngr
  - gdisk
  - gnupg
  - hdparm
  - htop
  - iptables
  - iputils-ping
  - ipvsadm
  - libseccomp2
  - lm-sensors
  - neovim
  - net-tools
  - nfs-common
  - nvme-cli
  - open-iscsi
  - parted
  - psmisc
  - smartmontools
  - software-properties-common
  - unzip
  - util-linux

growpart:
  mode: auto
resize_rootfs: true

runcmd:
  - swapoff -a
  - sed -i '/swap/d' /etc/fstab
  - systemctl daemon-reload
  - systemctl enable --now iscsid multipathd
  - systemctl reload ssh
  - systemctl enable k3s.service
  - systemctl start k3s.service || true
  - apt -y autoremove --purge
  - apt -y clean

#cloud-config
# Ironstone K3s Node Configuration
# This file is processed by cloud-init on first boot

# User configuration - create pi user, disable default ubuntu user
users:
    - name: pi
      groups: [adm, sudo]
      shell: /bin/bash
      sudo: ALL=(ALL) NOPASSWD:ALL
      lock_passwd: true
      create_groups: true
      homedir: /home/pi
      ssh_authorized_keys:
          - ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIMCLr7NoB34qERAAJNLHKgOy9EJ40smz4F9HhU5d5i8s

# Override default user to be pi instead of ubuntu
system_info:
    default_user:
        name: pi
        groups: [adm, sudo]
        shell: /bin/bash

# Run ironstone-init early to set hostname from MAC
bootcmd:
    - /usr/local/bin/ironstone-init.sh

# Timezone and locale
timezone: Europe/London
locale: en_GB.UTF-8

# Disable root login
disable_root: true

# SSH configuration
ssh_pwauth: false
ssh_genkeytypes: ["ed25519", "rsa"]
ssh_deletekeys: true

# Enable and configure services on first boot
runcmd:
    # Generate K3s config from template using build-time config
    - bash -c 'source /etc/ironstone/config && sed "s/\${K3S_VIP}/$K3S_VIP/g" /etc/rancher/k3s/config.yaml.template > /etc/rancher/k3s/config.yaml'
    - chmod 0644 /etc/rancher/k3s/config.yaml
    - systemctl enable k3s.service
    - systemctl start k3s.service

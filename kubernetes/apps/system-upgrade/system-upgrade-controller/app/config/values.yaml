---
# yaml-language-server: $schema=https://raw.githubusercontent.com/bjw-s/helm-charts/app-template-3.6.0/charts/other/app-template/values.schema.json
controllers:
  system-upgrade-controller:
    strategy: RollingUpdate
    containers:
      app:
        image:
          repository: docker.io/rancher/system-upgrade-controller
          tag: v0.16.2@sha256:ae933d9d81e9c42e316989a0ce7b1fb0dfe93afe5469631b8f384141b89b106a
        env:
          SYSTEM_UPGRADE_CONTROLLER_DEBUG: false
          SYSTEM_UPGRADE_CONTROLLER_THREADS: 2
          SYSTEM_UPGRADE_JOB_ACTIVE_DEADLINE_SECONDS: 900
          SYSTEM_UPGRADE_JOB_BACKOFF_LIMIT: 99
          SYSTEM_UPGRADE_JOB_IMAGE_PULL_POLICY: IfNotPresent
          SYSTEM_UPGRADE_JOB_KUBECTL_IMAGE: registry.k8s.io/kubectl:v1.34.0@sha256:497d298f891edb7608dfce9dae4bb08dffc4ddcd7f5d24a0512d4bbf33e04f26
          SYSTEM_UPGRADE_JOB_PRIVILEGED: true
          SYSTEM_UPGRADE_JOB_TTL_SECONDS_AFTER_FINISH: 900
          SYSTEM_UPGRADE_PLAN_POLLING_INTERVAL: 15m
          SYSTEM_UPGRADE_CONTROLLER_NAME: system-upgrade-controller
          SYSTEM_UPGRADE_CONTROLLER_NAMESPACE:
            valueFrom:
              fieldRef:
                fieldPath: metadata.namespace
        securityContext:
          allowPrivilegeEscalation: false
          readOnlyRootFilesystem: true
          capabilities: { drop: ["ALL"] }
          seccompProfile:
            type: RuntimeDefault
    pod:
      securityContext:
        runAsUser: 65534
        runAsGroup: 65534
        runAsNonRoot: true
      affinity:
        nodeAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
            nodeSelectorTerms:
              - matchExpressions:
                  - key: node-role.kubernetes.io/control-plane
                    operator: Exists
      tolerations:
        - key: CriticalAddonsOnly
          operator: Exists
        - key: node-role.kubernetes.io/control-plane
          operator: Exists
          effect: NoSchedule
        - key: node-role.kubernetes.io/master
          operator: Exists
          effect: NoSchedule

serviceAccount:
  create: true
  name: system-upgrade

service:
  app:
    controller: system-upgrade-controller
    enabled: false

persistence:
  tmp:
    type: emptyDir
    globalMounts:
      - path: /tmp
  etc-ssl:
    type: hostPath
    hostPath: /etc/ssl
    hostPathType: DirectoryOrCreate
    globalMounts:
      - path: /etc/ssl
        readOnly: true
  etc-pki:
    type: hostPath
    hostPath: /etc/pki
    hostPathType: DirectoryOrCreate
    globalMounts:
      - path: /etc/pki
        readOnly: true
  etc-ca-certificates:
    type: hostPath
    hostPath: /etc/ca-certificates
    hostPathType: DirectoryOrCreate
    globalMounts:
      - path: /etc/ca-certificates
        readOnly: true

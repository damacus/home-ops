# Claude Progress Notes - Storage Tasks

## Session: 2026-01-06

### Accomplished
- Verified all storage components in the cluster
- Ran InSpec storage validation tests (4/4 controls passing)
- Marked 5 storage tasks as passing in `.tasks/storage.json`

## Session: 2026-01-07 - RustFS & Volsync Configuration

### Accomplished

#### 1. RustFS Deployment Created
- **Location**: `kubernetes/apps/storage/rustfs/`
- **Components**:
  - HelmRelease using bjw-s app-template with rustfs/rustfs:1.0.0-alpha.76
  - PVC (500Gi on nfs-csi-ssd)
  - ExternalSecret for credentials (from 1Password)
  - HTTPRoutes for console (rustfs.ironstone.casa) and S3 API (rustfs-s3.ironstone.casa)
  - LoadBalancer IP: 192.168.1.229
  - ServiceMonitor for metrics

#### 2. Volsync ReplicationSources Configured
- **home-assistant** (`kubernetes/apps/home-automation/home-assistant/app/volsync/`):
  - Local backup to RustFS (daily at 2am)
  - Off-site backup to Cloudflare R2 (daily at 4am)
  - Using Direct copyMethod (NFS PVC doesn't support snapshots)

- **paperless** (`kubernetes/apps/home-automation/paperless/app/volsync/`):
  - Local backup to RustFS (daily at 3am)
  - Off-site backup to Cloudflare R2 (daily at 5am)
  - Using Direct copyMethod

#### 3. CNPG Backups Migrated to RustFS
- **home-assistant-db**: Updated to use `s3://cnpg-backups/home-assistant/` on local RustFS
- **mealie-db**: Updated to use `s3://cnpg-backups/mealie/` on local RustFS
- Created rustfs-cnpg ExternalSecrets in both namespaces

#### 4. Off-site Backup Strategy
- **Cloudflare R2** selected as off-site target:
  - Already configured in cluster
  - **Free egress** - no cost for restores
  - $0.015/GB/month storage (very competitive)
  - S3-compatible API

### Files Created/Modified
- `kubernetes/apps/storage/rustfs/` (new directory with full deployment)
- `kubernetes/apps/storage/kustomization.yaml` (added rustfs)
- `kubernetes/apps/volsync-system/volsync/app/helmrelease.yaml` (updated to onedr0p fork)
- `kubernetes/apps/home-automation/home-assistant/app/volsync/` (new)
- `kubernetes/apps/home-automation/paperless/app/volsync/` (new)
- `kubernetes/apps/home-automation/home-assistant-db/app/cluster.yaml` (CNPG to RustFS)
- `kubernetes/apps/home-automation/home-assistant-db/app/rustfs-externalsecret.yaml` (new)
- `kubernetes/apps/home/mealie-db/app/cluster.yaml` (CNPG to RustFS)
- `kubernetes/apps/home/mealie-db/app/rustfs-externalsecret.yaml` (new)
- `kubernetes/apps/home/mealie-db/app/kustomization.yaml` (new)

### 1Password Secrets Required
Before deployment, create these items in 1Password:
1. **rustfs** - with `RUSTFS_ROOT_USER` and `RUSTFS_ROOT_PASSWORD`
2. **volsync** - with `RESTIC_PASSWORD`
3. **cloudflare-r2** - with `R2_ACCOUNT_ID`, `R2_ACCESS_KEY_ID`, `R2_SECRET_ACCESS_KEY`

### Validation
- All manifests pass kubeconform validation

### Next Steps
1. Create required 1Password secrets
2. Commit and push changes
3. Wait for Flux to deploy RustFS
4. Create buckets in RustFS: `volsync-backups`, `cnpg-backups`
5. Verify Volsync ReplicationSources are running
6. Test backup/restore workflow
7. Monitor CNPG backup jobs

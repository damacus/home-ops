---
# yaml-language-server: $schema=https://taskfile.dev/schema.json
version: "3"
silent: true

vars:
  PROVISIONING_DIR: "{{.ROOT_DIR}}/provisioning"
  ARMBIAN_DIR: "{{.PROVISIONING_DIR}}/armbian-build"

tasks:
  build:
    desc: Build Armbian image for Rock 5B+
    dir: "{{.ARMBIAN_DIR}}"
    cmds:
      - |
        echo "Building Armbian image for Rock 5B+..."
        ./build.sh
        echo ""
        echo "Build complete. Image is in:"
        ls -lh armbian-build-repo/output/images/*.img 2>/dev/null || echo "  (check armbian-build-repo/output/images/)"

  copy:
    desc: Copy built image to ~/Downloads for flashing
    dir: "{{.ARMBIAN_DIR}}"
    cmds:
      - |
        LATEST=$(ls -t armbian-build-repo/output/images/*.img 2>/dev/null | head -1)
        if [ -z "$LATEST" ]; then
          echo "Error: No image found in armbian-build-repo/output/images/"
          exit 1
        fi
        FILENAME=$(basename "$LATEST")
        echo "Copying: $FILENAME to ~/Downloads/"
        cp "$LATEST" ~/Downloads/
        echo "Done. Image ready at ~/Downloads/$FILENAME"

  build-and-copy:
    desc: Build image and copy to ~/Downloads
    cmds:
      - task: build
      - task: copy

  clean:
    desc: Remove build artifacts to free disk space
    dir: "{{.ARMBIAN_DIR}}"
    cmds:
      - |
        echo "Cleaning Armbian build artifacts..."
        rm -rf armbian-build-repo/output/images/*.img
        rm -rf armbian-build-repo/output/images/*.img.xz
        rm -rf armbian-build-repo/.tmp
        echo "Done."

  audit:
    desc: Run InSpec tests against a running node
    requires:
      vars: [host]
    vars:
      AUDITOR:
        sh: command -v cinc-auditor || command -v inspec
    preconditions:
      - sh: command -v cinc-auditor || command -v inspec
        msg: "Neither cinc-auditor nor inspec found. Install with: brew install cinc-auditor"
    cmds:
      - |
        echo "Running node tests against {{.host}}..."
        {{.AUDITOR}} exec {{.PROVISIONING_DIR}}/tests/inspec-node \
          -t ssh://pi@{{.host}} \
          -i ~/.ssh/id_ed25519 \
          --reporter cli

  audit-image:
    desc: Run InSpec tests against a mounted image
    requires:
      vars: [mount]
    vars:
      AUDITOR:
        sh: command -v cinc-auditor || command -v inspec
    preconditions:
      - sh: command -v cinc-auditor || command -v inspec
        msg: "Neither cinc-auditor nor inspec found. Install with: brew install cinc-auditor"
    cmds:
      - |
        echo "Running image tests against {{.mount}}..."
        {{.AUDITOR}} exec {{.PROVISIONING_DIR}}/tests/inspec-image \
          -t local:// \
          --basedir "{{.mount}}" \
          --reporter cli

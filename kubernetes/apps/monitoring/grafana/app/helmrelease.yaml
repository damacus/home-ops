---
# yaml-language-server: $schema=https://kubernetes-schemas.pages.dev/helm.toolkit.fluxcd.io/helmrelease_v2.json
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: grafana
spec:
  interval: 30m
  timeout: 15m
  chart:
    spec:
      chart: grafana
      version: 9.2.4
      sourceRef:
        kind: HelmRepository
        name: grafana
        namespace: flux-system
  install:
    remediation:
      retries: 3
  upgrade:
    cleanupOnFail: true
    remediation:
      strategy: rollback
      retries: 3
  values:
    admin:
      # Reference the secret created by ExternalSecret
      existingSecret: grafana-secret
      userKey: admin-user
      passwordKey: admin-password

    ingress:
      enabled: true
      ingressClassName: internal
      hosts:
        - grafana.ironstone.casa
      annotations:
        external-dns.alpha.kubernetes.io/target: "${NGINX_INTERNAL_ADDR}"
      path: /
      tls:
        - secretName: grafana-tls
          hosts:
            - grafana.ironstone.casa

    persistence:
      enabled: true
      storageClassName: longhorn
      accessModes:
        - ReadWriteOnce
      size: 50Gi

    resources:
      requests:
        cpu: 1000m
        memory: 256Mi
      limits:
        cpu: 1000m
        memory: 256Mi

    envFrom:
      - secretRef:
          name: grafana-secret
      - secretRef:
          name: grafana-client

    # OIDC (Dex) authentication configuration
    # grafana.ini:
    # auth.generic_oauth:
    #   enabled: true
    #   name: Dex
    #   allow_sign_up: true
    #   client_id: grafana
    #   client_secret: $__env{client_secret}
    #   scopes: openid profile email groups
    #   auth_url: https://dex.damacus.io/auth
    #   token_url: https://dex.damacus.io/token
    #   api_url: https://dex.damacus.io/userinfo
    #   login_attribute_path: email
    #   name_attribute_path: email
    #   role_attribute_path: contains(groups[*], 'admin') && 'Admin' || 'Viewer'
    #   use_pkce: true
    #   tls_skip_verify_insecure: false
    # server:
    #   root_url: https://grafana.ironstone.casa/

    dataSources:
      - name: Prometheus
        type: prometheus
        url: http://kube-prometheus-stack-prometheus.monitoring.svc.cluster.local:9090
      - name: Alertmanager
        type: alertmanager
        url: http://kube-prometheus-stack-alertmanager.monitoring.svc.cluster.local:9093

    dashboards:
      default:
        # Node Exporter Dashboard for system metrics
        node-exporter:
          gnetId: 1860
          revision: 30
          datasource: Prometheus

        # Kubernetes cluster monitoring
        k8s-system:
          gnetId: 15661
          revision: 2
          datasource: Prometheus

        # Unifi Dashboard
        # unifi-dashboard:
        #   gnetId: 11315
        #   revision: 9
        #   datasource: Prometheus

        # Longhorn Storage Dashboard
        longhorn:
          gnetId: 16888
          revision: 1
          datasource: Prometheus

        # PostgreSQL Overview
        postgres:
          gnetId: 9628
          revision: 7
          datasource: Prometheus

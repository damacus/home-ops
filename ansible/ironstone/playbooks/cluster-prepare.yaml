---
- name: Prepare System
  hosts: kubernetes
  become: true
  gather_facts: true
  any_errors_fatal: true
  pre_tasks:
    - name: Pausing for 2 seconds...
      ansible.builtin.pause:
        seconds: 2
    - name: Populate service facts
      ansible.builtin.service_facts:

  tasks:
    - name: Locale
      block:
        - name: Locale | Set timezone
          community.general.timezone:
            name: "{{ timezone | default('Europe/London') }}"

    - name: Packages
      block:
        - name: Packages | Install ARM64
          ansible.builtin.apt:
            name:
              apt-transport-https,ca-certificates,conntrack,curl,hdparm,htop,iptables,
              iputils-ping,ipvsadm,net-tools,nfs-common,nvme-cli,open-iscsi,python3,
              smartmontools
            install_recommends: false

    - name: User Configuration
      block:
        - name: User Configuration | Silence login
          ansible.builtin.file:
            dest: "{{ '/home/' + ansible_user if ansible_user != 'root' else '/root' }}/.hushlogin"
            state: touch
            owner: "{{ ansible_user }}"
            group: "{{ ansible_user }}"
            mode: "0644"
            modification_time: preserve
            access_time: preserve

    - name: Create manifests directory
      ansible.builtin.file:
        path: /var/lib/rancher/k3s/server/manifests
        state: directory
        mode: '0755'

    - name: Add kube-vip to the manifests directory
      ansible.builtin.template:
        src: templates/kube-vip.yaml.j2
        dest: "/var/lib/rancher/k3s/server/manifests/kube-vip.yaml"
        mode: preserve

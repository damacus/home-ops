---
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: victoria-metrics
  namespace: monitoring
spec:
  interval: 30m
  chart:
    spec:
      chart: victoria-metrics-k8s-stack
      version: 0.67.0
      sourceRef:
        kind: HelmRepository
        name: victoria-metrics
        namespace: flux-system
  install:
    crds: Create
    remediation:
      retries: 3
  upgrade:
    cleanupOnFail: true
    crds: CreateReplace
    remediation:
      retries: 3
  values:
    fullnameOverride: vm
    victoria-metrics-operator:
      fullnameOverride: vm-operator
      enabled: true

    vmsingle:
      enabled: true
      spec:
        retentionPeriod: 14d
        storage:
          accessModes:
            - ReadWriteOnce
          resources:
            requests:
              storage: 20Gi
          storageClassName: openebs-hostpath

    vmagent:
      enabled: true
      spec:
        scrapeInterval: 30s
        # Select all ServiceMonitors to capture existing KPS targets + new ones
        serviceMonitorSelector: {}
        podMonitorSelector: {}
        selectAllServiceMonitors: true
        selectAllPodMonitors: true
        # Disk buffering configuration
        extraArgs:
          remoteWrite.tmpDataPath: /var/lib/vmagent-data
        volumes:
          - name: buffer-data
            hostPath:
              path: /var/lib/vmagent-buffer
              type: DirectoryOrCreate
        volumeMounts:
          - name: buffer-data
            mountPath: /var/lib/vmagent-data

    vmalert:
      enabled: true
      spec:
        # Select all PrometheusRules to capture existing KPS rules
        ruleSelector: {}
        selectAllRules: true

    alertmanager:
      enabled: true
      spec:
        # Use the existing Alertmanager configuration secret from KPS/ExternalSecret
        configSecret: alertmanager-secret

    # Disable components we don't need or are duplicated
    grafana:
      enabled: false

    # Enable node-exporter to replace KPS instance
    prometheus-node-exporter:
      enabled: true

    # Enable KubeStateMetrics to be self-contained (duplicates KPS KSM for now)
    kube-state-metrics:
      enabled: true

    # Scrape Core Components
    kubelet:
      enabled: true
    kubeApiServer:
      enabled: true
    kubeControllerManager:
      enabled: true
    kubeDns:
      enabled: true
    kubeEtcd:
      enabled: true
    kubeScheduler:
      enabled: true
    kubeProxy:
      enabled: false

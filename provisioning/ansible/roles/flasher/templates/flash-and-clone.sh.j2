#!/bin/bash
set -euo pipefail

# =============================================================================
# Ironstone Flash and Clone Script
# =============================================================================
# This script runs on first boot of the flasher image to:
# 1. Update firmware (board-specific)
# 2. Clone the gold master image from NFS to NVMe
# 3. Shutdown

BOARD="{{ target_board }}"
NFS_SERVER="{{ nfs_server }}"
NFS_PATH="{{ nfs_share }}"

echo "Starting Flash and Clone for $BOARD"

# 1. Firmware Update (Hardware Specific)
if [ "$BOARD" == "rpi5" ]; then
    echo "Configuring RPi5 EEPROM..."
    # Set Boot Order: Try NVMe (4), then SD (1)
    # 0xf41 -> 4 (NVMe) -> 1 (SD)
    if command -v rpi-eeprom-config &> /dev/null; then
        rpi-eeprom-config --apply BOOT_ORDER=0xf41
    else
        echo "Warning: rpi-eeprom-config not found!"
    fi
elif [ "$BOARD" == "rock5b" ]; then
    echo "Flashing SPI NOR for Rock 5B+..."
    # Flash SPI NOR for NVMe boot support
    if [ -f /opt/spi/rkspi_loader.img ]; then
        dd if=/opt/spi/rkspi_loader.img of=/dev/mtdblock0
        echo "SPI Flash complete."
    else
        echo "Error: /opt/spi/rkspi_loader.img not found!"
        exit 1
    fi
fi

# 2. Mount Network Storage
echo "Mounting NFS..."
mkdir -p /mnt/nfs
# Try to mount, retry a few times if network is slow to come up
for i in {1..10}; do
    mount -t nfs -o ro,nolock ${NFS_SERVER}:${NFS_PATH} /mnt/nfs && break
    echo "Mount failed, retrying in 5s..."
    sleep 5
done

if ! mountpoint -q /mnt/nfs; then
    echo "Error: Failed to mount NFS share."
    exit 1
fi

# 3. Clone Gold Master to NVMe
IMAGE_FILE="/mnt/nfs/${BOARD}-gold-latest.img"
TARGET_DRIVE="/dev/nvme0n1"

if [ ! -f "$IMAGE_FILE" ]; then
    echo "Error: Gold Master image not found at $IMAGE_FILE"
    exit 1
fi

echo "Cloning Gold Master ($IMAGE_FILE) to $TARGET_DRIVE..."
# Use dcfldd for status reporting if available, else dd
if command -v dcfldd &> /dev/null; then
    dcfldd if="$IMAGE_FILE" of="$TARGET_DRIVE" status=on bs=4M
else
    dd if="$IMAGE_FILE" of="$TARGET_DRIVE" status=progress bs=4M
fi

# 4. Verification (Optional)
echo "Syncing disks..."
sync

# 5. Done
echo "Flashing Complete. Shutting down..."
poweroff

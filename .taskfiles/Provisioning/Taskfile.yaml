---
# yaml-language-server: $schema=https://taskfile.dev/schema.json
version: "3"
silent: true

vars:
  PROVISIONING_DIR: "{{.ROOT_DIR}}/provisioning"
  BOARD: "{{.board | default \"rpi5\"}}"
  LIMA_VM: "ironstone"

tasks:
  check-lima:
    desc: Check if Lima is installed
    internal: true
    silent: true
    preconditions:
      - sh: command -v limactl
        msg: "Lima is not installed. Install with: brew install lima"

  check-vm:
    desc: Check if Lima VM is running, start if not
    internal: true
    deps: [check-lima]
    cmds:
      - |
        STATUS=$(limactl list --format '{{`{{.Status}}`}}' {{.LIMA_VM}} 2>/dev/null || echo "NotFound")
        if [ "$STATUS" = "NotFound" ]; then
          echo "Error: Lima VM '{{.LIMA_VM}}' does not exist."
          echo "Create it with: limactl create --name={{.LIMA_VM}} template://default"
          exit 1
        elif [ "$STATUS" != "Running" ]; then
          echo "Starting Lima VM '{{.LIMA_VM}}'..."
          limactl start {{.LIMA_VM}}
        else
          echo "Lima VM '{{.LIMA_VM}}' is running."
        fi

  build:
    desc: Build provisioning image via Lima VM
    deps: [check-vm]
    vars:
      GIT_SHA:
        sh: git rev-parse --short HEAD 2>/dev/null || echo "unknown"
    cmds:
      - |
        echo "Building {{.BOARD}}-gold image inside Lima VM..."
        limactl shell {{.LIMA_VM}} bash -c "cd {{.PROVISIONING_DIR}} && GIT_SHA={{.GIT_SHA}} ./build-native.sh {{.BOARD}} gold"

  copy:
    desc: Copy built image from Lima VM to ~/Downloads (for Raspberry Pi Imager/Etcher)
    deps: [check-lima]
    cmds:
      - |
        echo "Copying latest {{.BOARD}}-gold image from Lima VM..."
        # Get the most recent image file
        LATEST=$(limactl shell {{.LIMA_VM}} bash -c "ls -t ~/ironstone-builds/{{.BOARD}}-gold-*.img 2>/dev/null | head -1")
        if [ -z "$LATEST" ]; then
          echo "Error: No {{.BOARD}}-gold image found in Lima VM"
          exit 1
        fi
        FILENAME=$(basename "$LATEST")
        echo "Copying: $FILENAME to ~/Downloads/"
        limactl copy "{{.LIMA_VM}}:$LATEST" ~/Downloads/
        echo "Done. Image ready at ~/Downloads/$FILENAME"

  build-and-copy:
    desc: Build image and copy to local machine
    cmds:
      - task: build
      - task: copy

  clean:
    desc: Remove built images from Lima VM to free disk space
    deps: [check-lima]
    cmds:
      - |
        echo "Cleaning build artifacts from Lima VM..."
        limactl shell {{.LIMA_VM}} bash -c "rm -rf ~/ironstone-builds/*.img ~/ironstone-builds/*.img.xz 2>/dev/null || true"
        echo "Checking Lima VM disk usage..."
        limactl shell {{.LIMA_VM}} df -h /home
        echo "Done. Build artifacts removed."

  test:
    desc: Run provisioning tests (Bats)
    cmds:
      - "cd {{.PROVISIONING_DIR}} && bats tests/build.bats"

  audit:
    desc: Run CINC Auditor (InSpec) tests against a running node
    cmds:
      - |
        if [ -z "{{.host}}" ]; then
          echo "Usage: task provisioning:audit host=<ip-or-hostname>"
          exit 1
        fi
        AUDITOR=$(command -v cinc-auditor || command -v inspec || echo "")
        if [ -z "$AUDITOR" ]; then
          echo "Error: Neither cinc-auditor nor inspec found. Install with:"
          echo "  brew install cinc-auditor"
          exit 1
        fi
        echo "Running $AUDITOR tests against {{.host}}..."
        $AUDITOR exec {{.PROVISIONING_DIR}}/tests/inspec -t ssh://pi@{{.host}} -i ~/.ssh/id_ed25519 --reporter cli

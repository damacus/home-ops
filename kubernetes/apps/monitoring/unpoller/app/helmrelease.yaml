---
# yaml-language-server: $schema=https://kubernetes-schemas.pages.dev/helm.toolkit.fluxcd.io/helmrelease_v2.json
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: unpoller
spec:
  interval: 30m
  chart:
    spec:
      chart: unpoller
      version: 2.11.2
      sourceRef:
        kind: HelmRepository
        name: unpoller
        namespace: flux-system
  install:
    remediation:
      retries: 3
  upgrade:
    cleanupOnFail: true
    remediation:
      retries: 3
  uninstall:
    keepHistory: false
  values:
    replicaCount: 1
    image:
      repository: ghcr.io/unpoller/unpoller
      tag: v2.11.2
      pullPolicy: IfNotPresent

    resources:
      requests:
        cpu: 50m
        memory: 64Mi
      limits:
        cpu: 200m
        memory: 128Mi

    securityContext:
      allowPrivilegeEscalation: false
      readOnlyRootFilesystem: true
      runAsNonRoot: true
      runAsUser: 65534
      runAsGroup: 65534
      capabilities:
        drop:
          - ALL

    podSecurityContext:
      fsGroup: 65534
      runAsNonRoot: true
      seccompProfile:
        type: RuntimeDefault

    livenessProbe:
      httpGet:
        path: /metrics
        port: tcp
      initialDelaySeconds: 30
      periodSeconds: 30
      timeoutSeconds: 10
      failureThreshold: 3

    readinessProbe:
      httpGet:
        path: /metrics
        port: tcp
      initialDelaySeconds: 5
      periodSeconds: 10
      timeoutSeconds: 5
      failureThreshold: 3

    # Disable built-in dashboards as we already have Grafana configured
    dashboards:
      create: false

    # UnPoller configuration using config file format
    upConfig: |
      [poller]
        debug = false
        quiet = false
        plugins = []
      [prometheus]
        disable = false
        http_listen = "0.0.0.0:9130"
        report_errors = false
      [influxdb]
        disable = true
      [unifi]
        dynamic = false
      [loki]
        disable = true
      [[unifi.controller]]
        url = "https://unifi.ironstone.casa"
        user = "unpoller"
        pass = "${UNIFI_API_KEY}"
        sites = ["all"]
        save_ids = true
        save_dpi = false
        save_sites = true
        hash_pii = false
        verify_ssl = false

    # Environment variables for secret substitution
    env:
      - name: UNIFI_API_KEY
        valueFrom:
          secretKeyRef:
            name: unpoller-secret
            key: api-key

#!/bin/bash
# =============================================================================
# Ironstone Cloud-Init Datasource Setup
# =============================================================================
# This script runs before cloud-init to fetch config from Matchbox and
# set up the NoCloud datasource with local files.
# =============================================================================
set -euo pipefail

MATCHBOX_URL="{{ cloud_init_url }}"
SEED_DIR="/var/lib/cloud/seed/nocloud"
LOG_TAG="ironstone-datasource"

log() { logger -t "$LOG_TAG" "$*"; echo "[$(date '+%Y-%m-%d %H:%M:%S')] $*"; }

# Get the primary network interface MAC address
# Uses ip route to find the default interface - works regardless of naming scheme
get_mac() {
    local iface mac

    # Get the interface used for default route (most reliable method)
    iface=$(ip route show default 2>/dev/null | awk '/default/ {print $5; exit}')

    if [ -n "$iface" ] && [ -f "/sys/class/net/$iface/address" ]; then
        mac=$(cat "/sys/class/net/$iface/address")
        if [ -n "$mac" ] && [ "$mac" != "00:00:00:00:00:00" ]; then
            echo "$mac"
            return 0
        fi
    fi

    # Fallback: find first non-loopback, non-wireless interface with a valid MAC
    for iface_path in /sys/class/net/*; do
        iface=$(basename "$iface_path")
        [ "$iface" = "lo" ] && continue
        # Skip wireless interfaces
        [ -d "$iface_path/wireless" ] && continue
        [ ! -f "$iface_path/address" ] && continue
        mac=$(cat "$iface_path/address" 2>/dev/null || true)
        if [ -n "$mac" ] && [ "$mac" != "00:00:00:00:00:00" ]; then
            echo "$mac"
            return 0
        fi
    done

    return 1
}

MAC=$(get_mac)
if [ -z "$MAC" ]; then
    log "ERROR: Could not determine MAC address"
    exit 1
fi

log "Detected MAC address: $MAC"

# Create seed directory for NoCloud
mkdir -p "$SEED_DIR"

# Fetch cloud-config from Matchbox
CLOUD_URL="${MATCHBOX_URL}cloud?mac=${MAC}"
log "Fetching cloud-config from $CLOUD_URL"

if curl -sf "$CLOUD_URL" -o "$SEED_DIR/user-data"; then
    log "Successfully fetched user-data"
else
    log "WARNING: Failed to fetch cloud-config from Matchbox"
    # Create minimal user-data so cloud-init doesn't fail
    echo "#cloud-config" > "$SEED_DIR/user-data"
fi

# Fetch metadata from Matchbox
META_URL="${MATCHBOX_URL}metadata?mac=${MAC}"
log "Fetching metadata from $META_URL"

if curl -sf "$META_URL" -o /tmp/matchbox-metadata; then
    log "Successfully fetched metadata"
    # Convert matchbox KEY=VALUE format to YAML for cloud-init
    {
        echo "instance-id: $(hostname)-$(date +%s)"
        echo "local-hostname: $(grep '^HOSTNAME=' /tmp/matchbox-metadata | cut -d= -f2 || hostname)"
    } > "$SEED_DIR/meta-data"
else
    log "WARNING: Failed to fetch metadata from Matchbox"
    echo "instance-id: $(hostname)-$(date +%s)" > "$SEED_DIR/meta-data"
fi

log "NoCloud seed directory prepared:"
ls -la "$SEED_DIR"

# Update cloud-init datasource config to use local seed
cat > /etc/cloud/cloud.cfg.d/00-datasource.cfg << EOF
# Auto-generated by ironstone-datasource.service
# MAC: $MAC
datasource_list: [ NoCloud ]
datasource:
  NoCloud:
    fs_label: null
EOF

log "Datasource configuration complete"

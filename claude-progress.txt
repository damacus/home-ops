# Claude Progress Notes - Storage Tasks

## Session: 2026-01-06

### Accomplished
- Verified all storage components in the cluster
- Ran InSpec storage validation tests (4/4 controls passing)
- Marked 5 storage tasks as passing in `.tasks/storage.json`

## Session: 2026-01-07 - RustFS & Volsync Configuration

### Accomplished

#### 1. RustFS Deployment Created
- **Location**: `kubernetes/apps/storage/rustfs/`
- **Components**:
  - HelmRelease using bjw-s app-template with rustfs/rustfs:1.0.0-alpha.76
  - PVC (500Gi on nfs-csi-ssd)
  - ExternalSecret for credentials (from 1Password)
  - HTTPRoutes for console (rustfs.ironstone.casa) and S3 API (rustfs-s3.ironstone.casa)
  - LoadBalancer IP: 192.168.1.229
  - ServiceMonitor for metrics

#### 2. Volsync ReplicationSources Configured
- **home-assistant** (`kubernetes/apps/home-automation/home-assistant/app/volsync/`):
  - Local backup to RustFS (daily at 2am)
  - Off-site backup to Cloudflare R2 (daily at 4am)
  - Using Direct copyMethod (NFS PVC doesn't support snapshots)

- **paperless** (`kubernetes/apps/home-automation/paperless/app/volsync/`):
  - Local backup to RustFS (daily at 3am)
  - Off-site backup to Cloudflare R2 (daily at 5am)
  - Using Direct copyMethod

#### 3. CNPG Backups Migrated to RustFS
- **home-assistant-db**: Updated to use `s3://cnpg-backups/home-assistant/` on local RustFS
- **mealie-db**: Updated to use `s3://cnpg-backups/mealie/` on local RustFS
- Created rustfs-cnpg ExternalSecrets in both namespaces

#### 4. Off-site Backup Strategy
- **Cloudflare R2** selected as off-site target:
  - Already configured in cluster
  - **Free egress** - no cost for restores
  - $0.015/GB/month storage (very competitive)
  - S3-compatible API

### Files Created/Modified
- `kubernetes/apps/storage/rustfs/` (new directory with full deployment)
- `kubernetes/apps/storage/kustomization.yaml` (added rustfs)
- `kubernetes/apps/volsync-system/volsync/app/helmrelease.yaml` (updated to onedr0p fork)
- `kubernetes/apps/home-automation/home-assistant/app/volsync/` (new)
- `kubernetes/apps/home-automation/paperless/app/volsync/` (new)
- `kubernetes/apps/home-automation/home-assistant-db/app/cluster.yaml` (CNPG to RustFS)
- `kubernetes/apps/home-automation/home-assistant-db/app/rustfs-externalsecret.yaml` (new)
- `kubernetes/apps/home/mealie-db/app/cluster.yaml` (CNPG to RustFS)
- `kubernetes/apps/home/mealie-db/app/rustfs-externalsecret.yaml` (new)
- `kubernetes/apps/home/mealie-db/app/kustomization.yaml` (new)

### 1Password Secrets Required
Before deployment, create these items in 1Password:
1. **rustfs** - with `RUSTFS_ACCESS_KEY` and `RUSTFS_SECRET_KEY`
2. **volsync** - with `RESTIC_PASSWORD`
3. **cloudflare-r2** - with `R2_ACCOUNT_ID`, `R2_ACCESS_KEY_ID`, `R2_SECRET_ACCESS_KEY`

### Validation
- All manifests pass kubeconform validation

### Next Steps
1. Create required 1Password secrets
2. Commit and push changes
3. Wait for Flux to deploy RustFS
4. Create buckets in RustFS: `volsync-backups`, `cnpg-backups`
5. Verify Volsync ReplicationSources are running
6. Test backup/restore workflow
7. Monitor CNPG backup jobs

## Session: 2026-01-06 - Zitadel Identity Provider

### Accomplished

#### 1. Zitadel Deployment Created
- **PR**: https://github.com/damacus/home-ops/pull/2703
- **Location**: `kubernetes/apps/authentication/zitadel/`
- **Components**:
  - HelmRelease using zitadel chart v9.13.0
  - CNPG PostgreSQL cluster (`zitadel-db`) with MinIO backups
  - ExternalSecrets for masterkey, credentials, and Google IDP
  - HTTPRoute for `zitadel.ironstone.casa`
  - ServiceMonitor for metrics

#### 2. Features Configured
- **Passkeys/WebAuthn**: Enabled via `PasswordlessType: 1`
- **Multi-user support**: Login policy allows multiple users
- **Google OAuth**: Reuses existing Dex credentials via ExternalSecret
- **LDAP support**: Can be configured post-deployment
- **OIDC applications**: Ready for Mealie, Paperless-ngx, Grafana

#### 3. Task List Updated
- Updated `.tasks/kubernetes.json` to replace Authentik with Zitadel task
- Task now has 15 detailed steps covering full deployment and configuration

### Files Created
- `kubernetes/flux/repositories/helm/zitadel.yaml` (HelmRepository)
- `kubernetes/apps/authentication/zitadel-db/` (CNPG cluster)
- `kubernetes/apps/authentication/zitadel/` (HelmRelease, HTTPRoute, ExternalSecrets)
- `kubernetes/apps/authentication/zitadel/README.md` (documentation)

### 1Password Secrets Required
Before merging PR #2703, create these items:
1. **zitadel-db** - `username: zitadel`, `password: <secure>`
2. **zitadel-db-superuser** - `password: <secure>`
3. **zitadel** - `masterkey` (32 chars), `db_password`, `db_superuser_password`, `admin_username`, `admin_email`, `admin_password`

### Validation
- All manifests pass kubeconform validation
- PR created and awaiting CI checks

### Next Steps
1. Create required 1Password secrets
2. Merge PR after CI passes
3. Wait for Flux to deploy Zitadel
4. Access console at `https://zitadel.ironstone.casa`
5. Configure Google identity provider
6. Create OIDC applications for Mealie, Paperless-ngx, Grafana
7. Set up family user accounts
8. Enable passkey enrollment
